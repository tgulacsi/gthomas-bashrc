#!/bin/sh
sfn="$(gpgconf --list-dirs agent-ssh-socket)"
mkdir -p "$(dirname "$sfn")"
gfn="$(gpgconf --list-dirs agent-socket)"
mkdir -p "$(dirname "$gfn")"

systemctl --user start gpg-agent.service gpg-agent-ssh.socket gpg-agent.socket
if systemctl --user list-units --all gnome-keyring-daemon.service | grep -qF service; then
    systemctl --user start gnome-keyring-daemon.service
fi
#gpgconf --reload gpg-agent
#set -x
export "GPG_TTY=$(tty)"
if [ ! -e "$sfn" ] || [ ! -e "$sfn" ]; then
    systemctl --user stop gpg-agent.service 
    systemctl --user restart gpg-agent-ssh.socket gpg-agent.socket
fi
gpg-connect-agent updatestartuptty /bye >/dev/null

if [ -z "$SSH_AUTH_SOCK" ] || [ ! -e "$SSH_AUTH_SOCK" ] && [ -e "$sfn" ]; then
    export SSH_AUTH_SOCK="$sfn"
fi


if true; then
    #ssh-add 2>/dev/null
	ssh-add -l | grep -Fq 'SHA256:WmqucptQsstLxCvVq2gnJhORXCRr9bWlUTkY7Qk0+go' ||
		ssh-add ~/.ssh/TGulacsi.pem
fi
