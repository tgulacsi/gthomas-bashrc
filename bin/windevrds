#!/bin/sh
dest='10.65.85.40'
u=tgulacsi

prog=xfreerdp
if [ "${XDG_SESSION_TYPE:-}" = wayland ] && which wlfreerdp >/dev/null 2>/dev/null; then
	prog=wlfreerdp
fi
prog=${RDP:-$prog}

pkill -f "${prog}.*0x409 .* /v:${dest}"

p="$(pass show U/UNOSOFT/tgulacsi@unosoft/tgulacsi | head -n1)"
OPTS="/u:$u /d:unosoft"

OPTS="$OPTS /kbd:0x409 /cert-ignore /network:modem /drive:tmp,/tmp +drives +clipboard /workarea /v:$dest +fonts /from-stdin -decorations +auto-reconnect /auto-reconnect-max-retries:10"
SEC=${SEC:-/sec:nla}
if [ -z "${GW:-}" ]; then
	if ! ip route | grep -Fq 10.65.85. && ! ping -qnc 1 -w 1 "$dest"; then
		GW=rdg.unosoft.hu:4443
	fi
fi
if [ -n "$GW" ]; then
	OPTS="$OPTS /g:$GW /gu:$u /gp:$p /gd:unosoft"
fi


echo "+ ${prog} ${SEC} $OPTS" >&2
if [ "${DEBUG:-0}" -ne 1 ]; then
	exec >/dev/null 2>/dev/null
fi

echo "$p" | exec "${prog}" "${SEC}" $OPTS
