#!/bin/sh
if [ -e /etc/openvpn/client/unosoft.conf ]; then
	SVC=openvpn-client@unosoft
	TODO=restart
	if [ "$1" = down ]; then
		TODO=stop
		if ! systemctl status "$SVC" >/dev/null; then
			exit 0
		fi
	fi
	resolvectl dns tun0 10.65.85.1
	resolvectl domain tun0 unosoft.local
	resolvectl flush-caches
	exec systemctl "$TODO" "$SVC"
fi
cat <<EOF
sudo chown "$(id -un)" /etc/openvpn/client
cp -a ~/.ssh/fwas.unosoft.hu /etc/openvpn/client/
cd /etc/openvpn/client/
sed -e '/^ca /i cd fwas.unosoft.hu' fwas.unosoft.hu/openvpn_client.ovpn  >unosoft.conf
rm fwas.unosoft.hu/openvpn_client.ovpn
EOF
if [ -e ~/.ssh/fwas.unosoft.hu/openvpn_client.ovpn ]; then
	cd ~/.ssh/fwas.unosoft.hu/
	sudo pkill openvpn
	set -x
	exec sudo openvpn --config openvpn_client.ovpn #--daemon fwas.unosoft.hu
fi
DOWN=0
ID=unosoft
for arg in "$@"; do
	case "$arg" in
		down) DOWN=1
			;;
		*)
			ID="$arg"
			;;
	esac
done

if [ "${FULL:-0}" = 1 ] && nmcli con show --active | fgrep -q Alvallalkozok; then
	nmcli --ask con down id Alvallalkozok
	nmcli --ask con up id Alvallalkozok
fi
nmcli --ask con down id "$ID"
if [ $DOWN -eq 1 ]; then
	exit 0
fi

set -e
nmcli --ask con up id "$ID"
exec systemd-resolve -i tun0 --set-dns 10.65.85.1 --set-domain unosoft.local --set-domain hu.emea.aegon.com
